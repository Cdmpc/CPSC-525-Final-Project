# ============================================ [START OF EXPLOIT SCRIPT] ============================================ #
import os;
import sys;
import pexpect as pex;
import pexpect.popen_spawn as pop;
import signal;
import pathlib as plib;

DEBUG = os.environ.get("DEBUG", "0").lower() in ["1", "y", "yes", "true", "on", "color"];

# NOTE: This exploit script is meant to be run from the REPOSITORY DIRECTORY.
# i.e, the directory that is created when you CLONE this repository.
# ============================================= [HELPER FUNCTIONS] ============================================== #
def create_N_notes(N, srv_exepath, cli_exepath):
    # Open the server executable, on port 5400
    srv_process = pop.PopenSpawn(f"stdbuf -o0 {srv_exepath} 5400", timeout=5);
    srv_process.delaybeforesend = None;

    if DEBUG:
        srv_process.logfile = sys.stdout.buffer;
    
    # Create the N users
    for i in range(1, N + 1):
        # Open up the client as well, on the same port.
        cli_process = pop.PopenSpawn(f"stdbuf -o0 {cli_exepath} 127.0.0.1 5400", timeout=5);
        cli_process.delaybeforesend = None;

        if DEBUG:
            cli_process.logfile = sys.stdout.buffer;

        cli_process.expect_exact("Do you already have and account (Y/N) ? : ");
        cli_process.sendline("N");

        # Send in sample usernames with the same format : user_i
        cli_process.expect_exact("Please enter your username: ");
        cli_process.sendline(f"user_{i}");

        # Send in sample passwords with the same format : password_i
        cli_process.expect_exact("Please enter your password: ");
        cli_process.sendline(f"password_{i}");

        # NOTE: The temp.txt file is created automatically from the C++ program, 
        # once you enter a username and password.
        cli_process.expect_exact("(1, 2, 3) ? : ");

        # NOTE: Make sure to write to the created temp.txt file BEFORE entering "1" input.
        with open("./temp.txt", "w") as fp:
            fp.write(f"Hi, this is USER_{i}, and this file is my secret!");

        # Upload the file, which can be found at Secrets directory.
        cli_process.sendline("1");

        # Close the process, as the program will terminate once we enter and write the note and 
        # "1" input.
        cli_process.expect(pex.EOF, timeout=5);
        cli_process.kill(signal.SIGTERM);

    #TODO: Close the server process (might have to move this around.)
    srv_process.kill(signal.SIGTERM);


# ============================================= [MAIN DEFINITION] ============================================== #
def main(srv_exepath, cli_exepath):
    try:
        plib.Path("./temp.txt").unlink(missing_ok=True);
        # Let's create 10 users
        create_N_notes(N=100, srv_exepath=srv_exepath, cli_exepath=cli_exepath);
        print("create_N_notes() succeeded, check ./Secrets directory.");
    except Exception:
        print("create_N_notes() failed");

# ============================================= [MAIN CALL AND STARTING POINT] ============================================== #
if __name__ == "__main__":
    try:
        main(sys.argv[1], sys.argv[2]);
        print(" ============= [PROGRAM TERMINATED] =============");
    except Exception:
        print("\nCAUGHT ERROR: main() function failed, did you try: ");
        print("argv[1] == <path_to_server_executable>");
        print("argv[2] == <path_to_client_executable>");
        print("Usage: python3 ./Exploit/heap-exploit.py argv[1] argv[2]");